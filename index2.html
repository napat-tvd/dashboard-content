<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TVD Content Dashboard</title>

  <style>
    /* ====== Base & Theme ====== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #0f1420;
      --bg-card: linear-gradient(145deg, rgba(20, 28, 50, 0.8), rgba(15, 20, 35, 0.6));
      --border: rgba(100, 150, 255, 0.15);
      --border-hover: rgba(100, 150, 255, 0.3);
      --text-primary: #e8eaf0;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-purple: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.15);
    }

    body {
      font-family: 'Inter', 'Noto Sans Thai', system-ui, -apple-system, sans-serif;
      background: radial-gradient(ellipse at top, #1e293b 0%, var(--bg-primary) 50%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      pointer-events: none;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(30px, -30px); }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      position: relative;
      z-index: 1;
      animation: slideUp 0.6s ease-out;
    }

    /* ====== Header ====== */
    .header {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px 36px;
      margin-bottom: 28px;
      box-shadow: var(--shadow), var(--shadow-glow);
      display: flex;
      align-items: center;
      gap: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.03), transparent);
      animation: shimmer 3s infinite;
    }

    .header:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), 0 0 40px rgba(59, 130, 246, 0.2);
      border-color: var(--border-hover);
    }

    .logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 28px;
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .logo::after {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 18px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
      opacity: 0;
      transition: opacity 0.3s;
      z-index: -1;
      filter: blur(10px);
    }

    .logo:hover::after {
      opacity: 0.6;
    }

    .logo:hover {
      transform: scale(1.05) rotate(5deg);
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.5);
    }

    .header-content h1 {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 6px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .header:hover .header-content h1 {
      letter-spacing: 0.5px;
    }

    /* ===== Version pill (added) ===== */
    .version-pill{
      margin-left: 8px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 700;
      color: #e8eaf0;
      background: rgba(59,130,246,.15);
      border: 1px solid rgba(59,130,246,.35);
      border-radius: 999px;
      letter-spacing: .3px;
      cursor: default;
      position: relative;
      top: -1px;
    }
    .version-pill::after{
      content: attr(data-notes);
      white-space: pre-line;
      position: absolute;
      left: 0; top: 120%;
      transform: translateX(-10%);
      min-width: 220px;
      max-width: 280px;
      padding: 10px 12px;
      font-size: 12px;
      color: #e8eaf0;
      background: rgba(15,20,35,.95);
      border: 1px solid rgba(100,150,255,.25);
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      opacity: 0; pointer-events: none;
      transition: opacity .25s, transform .25s;
    }
    .version-pill:hover::after{
      opacity: 1; transform: translateX(-10%) translateY(2px);
    }

    .header-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      margin-left: auto;
      padding: 10px 20px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 999px;
      font-size: 13px;
      color: var(--success);
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .status-badge::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }

    .status-badge:hover::before {
      width: 300px;
      height: 300px;
    }

    .status-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* ====== Tabs ====== */
    .nav-tabs { display: flex; gap: 12px; margin-bottom: 28px; }
    .nav-tab {
      padding: 14px 28px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      transition: left 0.5s;
    }

    .nav-tab:hover::before {
      left: 100%;
    }

    .nav-tab:hover { 
      border-color: var(--border-hover); 
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      border-color: transparent;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }

    .nav-tab.active:hover {
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.6);
      transform: translateY(-4px);
    }

    /* ====== Filters ====== */
    .filters-panel {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 28px;
      box-shadow: var(--shadow), var(--shadow-glow);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filters-panel:hover {
      box-shadow: var(--shadow-lg), 0 0 30px rgba(59, 130, 246, 0.15);
      border-color: var(--border-hover);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-bottom: 20px;
    }

    .filter-group { 
      display: flex; 
      flex-direction: column; 
      gap: 10px;
    }

    .filter-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      transition: color 0.3s;
    }

    .filter-group:hover .filter-label {
      color: var(--accent-blue);
    }

    input, select {
      width: 100%;
      padding: 13px 18px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      outline: none;
    }

    input:hover, select:hover {
      border-color: var(--border-hover);
      background: rgba(15, 20, 32, 0.8);
    }

    input:focus, select:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
      background: var(--bg-secondary);
      transform: translateY(-1px);
    }

    .date-range { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

    .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; }

    button {
      padding: 13px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover { 
      border-color: var(--border-hover); 
      transform: translateY(-3px); 
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(-1px);
    }

    button.primary { 
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); 
      border: none; 
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    button.primary:hover { 
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.6);
      transform: translateY(-4px);
    }

    /* ====== KPI ====== */
    .kpi-grid { 
      display: grid;
      gap: 18px;
      margin-bottom: 28px;
      grid-template-rows: auto auto;
    }
    
    .kpi-row {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(4, 1fr);
    }
    
    .kpi-card {
      background: var(--bg-card); 
      backdrop-filter: blur(20px); 
      border: 1px solid var(--border);
      border-radius: 20px; 
      padding: 24px; 
      box-shadow: var(--shadow), var(--shadow-glow); 
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; 
      overflow: hidden;
      animation: slideUp 0.6s ease-out backwards;
    }

    .kpi-card:nth-child(1) { animation-delay: 0.1s; }
    .kpi-card:nth-child(2) { animation-delay: 0.15s; }
    .kpi-card:nth-child(3) { animation-delay: 0.2s; }
    .kpi-card:nth-child(4) { animation-delay: 0.25s; }

    .kpi-card::before { 
      content: ''; 
      position: absolute; 
      top: 0; 
      left: 0; 
      right: 0; 
      height: 4px; 
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
      transition: height 0.3s;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s;
    }

    .kpi-card:hover::after {
      opacity: 1;
    }

    .kpi-card:hover { 
      transform: translateY(-8px) scale(1.02); 
      box-shadow: var(--shadow-lg), 0 0 40px rgba(59, 130, 246, 0.3);
      border-color: var(--border-hover); 
    }

    .kpi-card:hover::before {
      height: 6px;
    }

    .kpi-label { 
      font-size: 13px; 
      color: var(--text-secondary); 
      text-transform: uppercase; 
      letter-spacing: 0.8px; 
      margin-bottom: 12px; 
      font-weight: 700;
      transition: color 0.3s;
    }

    .kpi-card:hover .kpi-label {
      color: var(--accent-cyan);
    }

    .kpi-value { 
      font-size: 36px; 
      font-weight: 700; 
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent;
      transition: transform 0.3s;
      display: inline-block;
    }

    .kpi-card:hover .kpi-value {
      transform: scale(1.1);
    }

    /* ====== Charts ====== */
    .charts-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); 
      gap: 18px; 
      margin-bottom: 28px; 
    }

    .chart-card { 
      background: var(--bg-card); 
      backdrop-filter: blur(20px); 
      border: 1px solid var(--border); 
      border-radius: 20px; 
      padding: 28px; 
      box-shadow: var(--shadow), var(--shadow-glow);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .chart-card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      opacity: 0;
      transition: opacity 0.3s;
      z-index: -1;
      border-radius: 20px;
    }

    .chart-card:hover::before {
      opacity: 0.15;
    }

    .chart-card:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-lg), 0 0 40px rgba(59, 130, 246, 0.25);
      border-color: var(--border-hover);
    }

    .chart-title { 
      font-size: 17px; 
      font-weight: 700; 
      margin-bottom: 20px; 
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: color 0.3s;
    }

    .chart-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, var(--accent-blue), var(--accent-cyan));
      border-radius: 2px;
      transition: height 0.3s;
    }

    .chart-card:hover .chart-title {
      color: var(--accent-cyan);
    }

    .chart-card:hover .chart-title::before {
      height: 24px;
    }

    /* ====== Table ====== */
    .table-container { 
      background: var(--bg-card); 
      backdrop-filter: blur(20px); 
      border: 1px solid var(--border); 
      border-radius: 20px; 
      overflow: hidden; 
      box-shadow: var(--shadow), var(--shadow-glow);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .table-container:hover {
      box-shadow: var(--shadow-lg), 0 0 30px rgba(59, 130, 246, 0.2);
      border-color: var(--border-hover);
    }

    .table-wrapper { 
      overflow-x: auto;
      max-height: 700px;
      overflow-y: auto;
      position: relative;
    }

    table { 
      width: 100%; 
      border-collapse: collapse;
    }

    thead { 
      background: linear-gradient(135deg, rgba(20, 28, 50, 0.95), rgba(15, 20, 35, 0.9)); 
      position: sticky; 
      top: 0; 
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* กำหนดความกว้างที่แน่นอนให้ทุก column */
    th:nth-child(1), td:nth-child(1) { width: 60px; min-width: 60px; max-width: 60px; text-align: center; } /* # */
    th:nth-child(2), td:nth-child(2) { width: 90px; min-width: 90px; max-width: 90px; text-align: center; } /* จำนวน */
    th:nth-child(3), td:nth-child(3) { width: 200px; min-width: 200px; max-width: 200px; } /* Platform */
    th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; max-width: 150px; } /* Product */
    th:nth-child(5), td:nth-child(5) { width: 150px; min-width: 150px; max-width: 150px; } /* Type */
    th:nth-child(6), td:nth-child(6) { width: 250px; min-width: 250px; max-width: 250px; } /* Project */
    th:nth-child(7), td:nth-child(7) { width: 180px; min-width: 180px; max-width: 180px; } /* Remark */
    th:nth-child(8), td:nth-child(8) { width: 120px; min-width: 120px; max-width: 120px; } /* Designer */
    th:nth-child(9), td:nth-child(9) { width: 110px; min-width: 110px; max-width: 110px; text-align: center; } /* Date */
    th:nth-child(10), td:nth-child(10) { width: 110px; min-width: 110px; max-width: 110px; text-align: center; } /* Deadline */
    th:nth-child(11), td:nth-child(11) { width: 140px; min-width: 140px; max-width: 140px; text-align: center; } /* Status */

    th {
      padding: 18px 12px; 
      text-align: left; 
      font-size: 12px; 
      font-weight: 700; 
      color: var(--text-secondary);
      text-transform: uppercase; 
      letter-spacing: 0.8px; 
      border-bottom: 2px solid var(--border);
      cursor: pointer; 
      user-select: none;
      transition: all 0.3s;
      position: relative;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
      transition: width 0.3s;
    }

    th:hover { 
      color: var(--accent-cyan);
      background: rgba(59, 130, 246, 0.05);
    }

    th:hover::after {
      width: 100%;
    }

    td { 
      padding: 18px 12px; 
      border-bottom: 1px solid var(--border); 
      font-size: 14px;
      transition: all 0.3s;
      vertical-align: middle;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* แก้ไข Platform cell เฉพาะ */
    tbody td:nth-child(3) {
      white-space: normal;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      padding: 12px;
    }

    tbody tr { 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    tbody tr::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
      transition: width 0.4s;
    }

    tbody tr:hover::before {
      width: 100%;
    }

    tbody tr:hover { 
      background: rgba(59, 130, 246, 0.08);
      transform: scale(1.005);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    /* ====== Badges ====== */
    .badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 7px 14px; 
      border-radius: 999px; 
      font-size: 12px; 
      font-weight: 700; 
      border: 1px solid;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .badge::before { 
      content: ''; 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      display: inline-block;
      transition: all 0.3s;
      animation: pulse 2s ease-in-out infinite;
    }

    .badge:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .badge:hover::before {
      animation: none;
      transform: scale(1.3);
    }

    .badge-done    { background: rgba(16,185,129, .15); border-color: rgba(16,185,129,.4); color: var(--success); }
    .badge-done::before { background: var(--success); box-shadow: 0 0 8px var(--success); }
    
    .badge-ongoing { background: rgba(59,130,246, .15); border-color: rgba(59,130,246,.4); color: var(--accent-blue); }
    .badge-ongoing::before { background: var(--accent-blue); box-shadow: 0 0 8px var(--accent-blue); }
    
    .badge-overdue { background: rgba(239,68,68, .15); border-color: rgba(239,68,68,.4); color: var(--danger); }
    .badge-overdue::before { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
    
    .badge-pending { background: rgba(245,158,11, .15); border-color: rgba(245,158,11,.4); color: var(--warning); }
    .badge-pending::before { background: var(--warning); box-shadow: 0 0 8px var(--warning); }

    .platform-tag {
      padding: 6px 12px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-purple);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-block;
      margin: 2px;
      white-space: nowrap;
    }

    .platform-tag:hover {
      background: rgba(139, 92, 246, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    /* เพิ่ม styling สำหรับ Platform cell ที่มีหลาย tags */
    tbody td:nth-child(3) {
      white-space: normal !important;
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 4px !important;
      align-items: center !important;
      padding: 12px !important;
    }

    /* ป้องกันการ shift ของ cell อื่นๆ */
    tbody td {
      vertical-align: middle;
    }

    /* แก้ไขความกว้างของ columns */
    th:nth-child(1), td:nth-child(1) { width: 60px; min-width: 60px; max-width: 60px; text-align: center; } /* # */
    th:nth-child(2), td:nth-child(2) { width: 90px; min-width: 90px; max-width: 90px; text-align: center; } /* จำนวน */
    th:nth-child(3), td:nth-child(3) { width: 200px; min-width: 200px; max-width: 200px; } /* Platform */
    th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; max-width: 150px; } /* Product */
    th:nth-child(5), td:nth-child(5) { width: 150px; min-width: 150px; max-width: 150px; } /* Type */
    th:nth-child(6), td:nth-child(6) { width: 250px; min-width: 250px; max-width: 250px; } /* Project */
    th:nth-child(7), td:nth-child(7) { width: 180px; min-width: 180px; max-width: 180px; } /* Remark */
    th:nth-child(8), td:nth-child(8) { width: 120px; min-width: 120px; max-width: 120px; } /* Designer */
    th:nth-child(9), td:nth-child(9) { width: 110px; min-width: 110px; max-width: 110px; text-align: center; } /* Date */
    th:nth-child(10), td:nth-child(10) { width: 110px; min-width: 110px; max-width: 110px; text-align: center; } /* Deadline */
    th:nth-child(11), td:nth-child(11) { width: 140px; min-width: 140px; max-width: 140px; text-align: center; } /* Status */

    .hidden { display: none; }

    /* ====== Responsive ====== */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .header { 
        flex-direction: column; 
        text-align: center;
        padding: 24px;
      }
      .status-badge { margin-left: 0; }
      .filters-grid { grid-template-columns: 1fr; }
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .action-buttons { 
        width: 100%;
      }
      button {
        flex: 1;
        min-width: 120px;
      }
      .nav-tabs {
        width: 100%;
      }
      .nav-tab {
        flex: 1;
        text-align: center;
      }
    }

    /* Loading animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      animation: spin 1s linear infinite;
    }

    /* Scroll animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeInUp 0.6s ease-out;
    }

    /* Custom Scrollbar */
    .table-wrapper::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .table-wrapper::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 10px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 10px;
      transition: all 0.3s;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
    }

    /* Firefox */
    .table-wrapper {
      scrollbar-width: thin;
      scrollbar-color: var(--accent-blue) var(--bg-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ====== Header ====== -->
    <div class="header">
      <div class="logo">TV</div>
      <div class="header-content">
        <h1>
          TVD Content Report
          <!-- version pill added -->
          <span class="version-pill" data-notes="อัพเดทเพิ่ม Animation&#10;ปรับบัคตาราง">ver.1.0.1</span>
        </h1>
        <div class="header-subtitle">แดชบอร์ดเชื่อม Google Sheet • วิเคราะห์แบบเรียลไทม์</div>
      </div>
      <div class="status-badge" id="connectionStatus">⚡ กำลังเชื่อมต่อ...</div>
    </div>

    <!-- ====== Tabs ====== -->
    <div class="nav-tabs">
      <button class="nav-tab active" data-page="dashboard">📊 Dashboard</button>
      <button class="nav-tab" data-page="details">📋 รายการงาน</button>
    </div>

    <!-- ====== Filters ====== -->
    <div class="filters-panel">
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">🔍 ค้นหา</label>
          <input id="searchInput" type="search" placeholder="ค้นหา Project, Product, Remark...">
        </div>

        <div class="filter-group">
          <label class="filter-label">📱 Platform</label>
          <select id="platformFilter">
            <option value="">ทุกแพลตฟอร์ม</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">👤 Designer</label>
          <select id="designerFilter" style="display:none;">
            <option value="">ทุกดีไซเนอร์</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">📌 สถานะ</label>
          <select id="statusFilter">
            <option value="">ทุกสถานะ</option>
            <option value="เสร็จแล้ว">เสร็จแล้ว</option>
            <option value="อยู่ในกำหนด">อยู่ในกำหนด</option>
            <option value="เลยกำหนด">เลยกำหนด</option>
            <option value="ยังไม่ได้กำหนด">ยังไม่ได้กำหนด</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">🎨 ประเภทงาน</label>
          <select id="categoryFilter">
            <option value="">ทุกประเภท</option>
            <option value="artwork">Artwork</option>
            <option value="video">Video</option>
            <option value="motion">Motion Graphic</option>
            <option value="script">Script ออกอง</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">📅 อิงวันที่</label>
          <select id="dateSourceFilter">
            <option value="Deadline">Deadline</option>
            <option value="Date">Date</option>
            <option value="MaxDate">MaxDate</option>
          </select>
        </div>

        <div class="filter-group date-range">
          <div>
            <label class="filter-label">จาก</label>
            <input id="dateFrom" type="date">
          </div>
          <div>
            <label class="filter-label">ถึง</label>
            <input id="dateTo" type="date">
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button id="btn7Days">7 วันล่าสุด</button>
        <button id="btn30Days">30 วันล่าสุด</button>
        <button id="btnThisMonth">เดือนนี้</button>
        <button id="importBtn">📁 นำเข้า CSV</button>
        <button id="exportBtn" class="primary">💾 ส่งออก PDF</button>
        <button id="resetBtn">🔄 รีเซ็ต</button>
      </div>
    </div>

    <!-- ====== Dashboard ====== -->
    <div id="dashboardView">
      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">งานทั้งหมด</div>
            <div class="kpi-value" id="kpiTotal">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">✅ เสร็จแล้ว</div>
            <div class="kpi-value" id="kpiDone">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">⏳ อยู่ในกำหนด</div>
            <div class="kpi-value" id="kpiOngoing">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">⚠️ เลยกำหนด</div>
            <div class="kpi-value" id="kpiOverdue">0</div>
          </div>
        </div>
        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">🎨 Artwork</div>
            <div class="kpi-value" id="kpiArtwork">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">🎬 Video</div>
            <div class="kpi-value" id="kpiVideo">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">✨ Motion</div>
            <div class="kpi-value" id="kpiMotion">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">📝 Script</div>
            <div class="kpi-value" id="kpiScript">0</div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">สถานะงาน</div>
          <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Platform</div>
          <canvas id="platformChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">ประเภทงาน</div>
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ====== Details ====== -->
    <div id="detailsView" class="hidden">
      <div class="table-container">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th data-sort="row">#</th>
                <th data-sort="__qty">จำนวน</th>
                <th data-sort="Platform">Platform</th>
                <th data-sort="Product">Product</th>
                <th data-sort="Type">Type</th>
                <th data-sort="Project">Project</th>
                <th data-sort="Remark">Remark</th>
                <th data-sort="Designer">Designer</th>
                <th data-sort="Date">Date</th>
                <th data-sort="Deadline">Deadline</th>
                <th data-sort="Status">Status</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden input for CSV import -->
  <input type="file" id="csvFileInput" accept=".csv" style="display:none" />

  <!-- ====== Libraries ====== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ====== App Script ====== -->
  <script>
    /* ==============================
       CONFIG
    =============================== */
    const CONFIG = {
      SHEET_URL: 'https://script.google.com/macros/s/AKfycbyaUue8SRvfSnaQxBhG5jJs9fv6pHevhL0aJisElYZtq3h4B6cYupguQF-kT1r28JhK/exec'
    };

    /* ==============================
       STATE
    =============================== */
    let data = [];
    let filteredData = [];
    let sortKey = 'row';
    let sortDir = 1;
    let charts = {};

    /* ==============================
       HELPERS
    =============================== */
    const TH_MONTHS = {
      "ม.ค.": 1, "ก.พ.": 2, "มี.ค.": 3, "เม.ย.": 4, "พ.ค.": 5, "มิ.ย.": 6,
      "ก.ค.": 7, "ส.ค.": 8, "ก.ย.": 9, "ต.ค.": 10, "พ.ย.": 11, "ธ.ค.": 12
    };

    function toBool(v) {
      if (typeof v === 'boolean') return v;
      const s = String(v || '').trim().toLowerCase();
      return ['true', '1', 'yes', 'y', '✓', 'done'].includes(s);
    }

    function parseThaiDate(str) {
      if (!str) return null;
      const s = String(str).trim();

      const dmyMatch = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (dmyMatch) {
        const [_, day, month, year] = dmyMatch;
        return new Date(year, month - 1, parseInt(day));
      }

      if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        const d = new Date(s);
        if (!isNaN(d)) return d;
      }

      const thMatch = s.match(/(\d{1,2})\s*\/\s*([ก-๛\.]+)\s*\/\s*(\d{2,4})/);
      if (thMatch) {
        const day = parseInt(thMatch[1]);
        const monthStr = thMatch[2].replace(/\s+/g, '');
        let year = parseInt(thMatch[3]);
        
        const month = TH_MONTHS[monthStr];
        if (!month) return null;
        
        if (year < 100) year = 2000 + year;
        if (year > 2400) year -= 543;
        
        return new Date(year, month - 1, day);
      }

      return null;
    }

    function fmtDateDisplay(v) {
      if (!v) return '-';
      
      if (typeof v === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)) {
        return v;
      }
      
      const d = parseThaiDate(v);
      if (!d) return v || '-';
      
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function getUniqueValues(arr, key) {
      const values = new Set();
      arr.forEach(item => {
        const val = (item?.[key] ?? '').toString().trim();
        if (!val) return;
        
        // แยก Platform ที่มีหลายค่า (คั่นด้วย comma)
        if (key === 'Platform' && val.includes(',')) {
          val.split(',').forEach(v => {
            const cleaned = v.trim();
            if (cleaned) values.add(cleaned);
          });
        } else {
          values.add(val);
        }
      });
      return Array.from(values).sort();
    }

    function getCategory(row) {
      const text = [row.Type, row.Remark, row.Project].join(' ').toLowerCase();
      if (text.includes('ออกแบบใหม่') || text.includes('re design')) return 'artwork';
      if (text.includes('ตัดคลิป') || text.includes('video')) return 'video';
      if (text.includes('motion')) return 'motion';
      if (text.includes('จองคิว') || text.includes('script')) return 'script';
      return '';
    }

    function getQty(row){
      const raw = row['จำนวนชิ้น'] ?? row['Quantity'] ?? row['qty'] ?? row['Qty'];
      const n = Number(String(raw ?? '').toString().replace(/[, ]/g,'').trim());
      return Number.isFinite(n) && n > 0 ? n : 0;
    }

    function isMeaningfulRow(r){
      const hasCore =
        [r.Platform, r.Product, r.Project, r.Type, r.Remark].some(v => (v ?? '').toString().trim() !== '');
      const hasAnyDate = !!(parseThaiDate(r.Date) || parseThaiDate(r.Deadline) || parseThaiDate(r.Finish));
      const approved = toBool(r.Approved);
      const hasStatus = (r.Status ?? '').toString().trim() !== '';
      const qty = getQty(r);
      return hasCore || hasAnyDate || hasStatus || approved || qty > 0;
    }

    function computeStatus(row) {
      if (toBool(row.Approved)) return 'เสร็จแล้ว';

      if (row.Status) {
        const s = String(row.Status).trim();
        if (['เสร็จแล้ว', 'อยู่ในกำหนด', 'เลยกำหนด', 'ยังไม่ได้กำหนด'].includes(s)) {
          return s;
        }
      }

      const finish = row.Finish ? parseThaiDate(row.Finish) : null;
      if (finish) return 'เสร็จแล้ว';

      const deadline = row.Deadline ? parseThaiDate(row.Deadline) : null;
      if (deadline) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return deadline < today ? 'เลยกำหนด' : 'อยู่ในกำหนด';
      }

      return 'ยังไม่ได้กำหนด';
    }

    /* ==============================
       LOAD DATA
    =============================== */
    async function loadData() {
      const statusEl = document.getElementById('connectionStatus');

      try {
        if (!CONFIG.SHEET_URL) throw new Error('No URL');

        statusEl.textContent = '⚡ กำลังโหลด...';

        const res = await fetch(CONFIG.SHEET_URL, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const result = await res.json();
        const rows = Array.isArray(result) ? result : (result.rows || []);

        data = rows.map(r => ({ ...r, Approved: toBool(r.Approved) })).filter(isMeaningfulRow);

        statusEl.textContent = '✅ เชื่อมต่อสำเร็จ';
        statusEl.style.background = 'rgba(16, 185, 129, 0.1)';
        statusEl.style.borderColor = 'rgba(16, 185, 129, 0.3)';
        statusEl.style.color = 'var(--success)';
      } catch (error) {
        console.error('Load error:', error);
        data = [];
        statusEl.textContent = '❌ โหลดข้อมูลไม่สำเร็จ';
        statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
        statusEl.style.borderColor = 'rgba(239, 68, 68, 0.3)';
        statusEl.style.color = 'var(--danger)';
      }

      buildFilters();
      applyFilters();
    }

    /* ==============================
       FILTERS
    =============================== */
    function buildFilters() {
      const platformSelect = document.getElementById('platformFilter');
      const designerSelect = document.getElementById('designerFilter');

      platformSelect.innerHTML = '<option value="">ทุกแพลตฟอร์ม</option>';
      designerSelect.innerHTML = '<option value="">ทุกดีไซเนอร์</option>';

      getUniqueValues(data, 'Platform').forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        platformSelect.appendChild(opt);
      });

      getUniqueValues(data, 'Designer').forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        designerSelect.appendChild(opt);
      });

      if (designerSelect.children.length > 1) {
        designerSelect.style.display = '';
      }
    }

    function applyFilters() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const platform = document.getElementById('platformFilter').value;
      const designer = document.getElementById('designerFilter').value;
      const status = document.getElementById('statusFilter').value;
      const category = document.getElementById('categoryFilter').value;
      const dateKey = document.getElementById('dateSourceFilter').value || 'Deadline';

      let dateFrom = null;
      let dateTo = null;
      
      const dfStr = document.getElementById('dateFrom').value;
      const dtStr = document.getElementById('dateTo').value;
      
      if (dfStr) {
        dateFrom = new Date(dfStr);
        dateFrom.setHours(0, 0, 0, 0);
      }
      
      if (dtStr) {
        dateTo = new Date(dtStr);
        dateTo.setHours(23, 59, 59, 999);
      }

      const useDateRange = !!(dateFrom || dateTo);

      filteredData = data.filter(row => {
        const rowStatus = computeStatus(row);
        const rowCategory = getCategory(row);

        const matchSearch = !search || [
          row.Project, row.Product, row.Remark, row.Type, row.Platform
        ].some(field => (field || '').toString().toLowerCase().includes(search));

        // แก้ไข Platform matching ให้รองรับหลายค่า
        let matchPlatform = true;
        if (platform) {
          const platforms = (row.Platform || '').split(',').map(p => p.trim());
          matchPlatform = platforms.includes(platform);
        }

        const matchDesigner = !designer || row.Designer === designer;
        const matchStatus = !status || rowStatus === status;
        const matchCategory = !category || rowCategory === category;

        let matchDate = true;
        if (useDateRange) {
          const baseDate = parseThaiDate(row[dateKey]);
          if (!baseDate) return false;

          if (dateFrom && baseDate < dateFrom) return false;
          if (dateTo && baseDate > dateTo) return false;
        }

        return matchSearch && matchPlatform && matchDesigner && matchStatus && matchCategory && matchDate;
      });

      updateKPIs();
      updateCharts();
      updateTable();
    }

    /* ==============================
       KPI
    =============================== */
    function updateKPIs() {
      const done = filteredData.filter(r => computeStatus(r) === 'เสร็จแล้ว').length;
      const ongoing = filteredData.filter(r => computeStatus(r) === 'อยู่ในกำหนด').length;
      const overdue = filteredData.filter(r => computeStatus(r) === 'เลยกำหนด').length;

      document.getElementById('kpiTotal').textContent   = filteredData.length;
      document.getElementById('kpiDone').textContent    = done;
      document.getElementById('kpiOngoing').textContent = ongoing;
      document.getElementById('kpiOverdue').textContent = overdue;

      const isArtwork = r => (r.Type || '').toLowerCase().includes('ออกแบบใหม่') || (r.Type || '').toLowerCase().includes('re design');
      const isVideo   = r => (r.Type || '').toLowerCase().includes('ตัดคลิป') || (r.Type || '').toLowerCase().includes('video');
      const isMotion  = r => (r.Type || '').toLowerCase().includes('motion');
      const isScript  = r => (r.Type || '').toLowerCase().includes('จองคิว') || (r.Type || '').toLowerCase().includes('script');

      const artworkRows   = filteredData.filter(isArtwork);
      const artworkCount  = artworkRows.length;
      const artworkImages = artworkRows.reduce((sum,r)=> sum + getQty(r), 0);

      const videoCount  = filteredData.filter(isVideo).length;
      const motionCount = filteredData.filter(isMotion).length;
      const scriptCount = filteredData.filter(isScript).length;

      document.getElementById('kpiArtwork').innerHTML = `${artworkCount}<div style="font-size:12px;color:#9ca3af">ภาพทั้งหมด ${artworkImages} รูป</div>`;
      document.getElementById('kpiVideo').textContent   = String(videoCount);
      document.getElementById('kpiMotion').textContent  = String(motionCount);
      document.getElementById('kpiScript').textContent  = String(scriptCount);
    }

    /* ==============================
       CHARTS
    =============================== */
    function updateCharts() {
      // Status Chart
      const statusLabels = ['เสร็จแล้ว', 'อยู่ในกำหนด', 'เลยกำหนด', 'ยังไม่ได้กำหนด'];
      const statusData = statusLabels.map(label =>
        filteredData.filter(r => computeStatus(r) === label).length
      );

      if (!charts.status) {
        charts.status = new Chart(document.getElementById('statusChart'), {
          type: 'doughnut',
          data: {
            labels: statusLabels,
            datasets: [{
              data: statusData,
              backgroundColor: ['#10b981', '#3b82f6', '#ef4444', '#f59e0b'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#e8eaf0', padding: 15 } }
            },
            cutout: '65%'
          }
        });
      } else {
        charts.status.data.datasets[0].data = statusData;
        charts.status.update();
      }

      // Platform Chart - แก้ไขให้นับแยก Platform
      const platformCounts = {};
      filteredData.forEach(row => {
        const platforms = (row.Platform || '').split(',').map(p => p.trim()).filter(Boolean);
        platforms.forEach(p => {
          platformCounts[p] = (platformCounts[p] || 0) + 1;
        });
      });
      
      const platforms = Object.keys(platformCounts).sort();
      const platformData = platforms.map(p => platformCounts[p]);

      if (!charts.platform) {
        charts.platform = new Chart(document.getElementById('platformChart'), {
          type: 'bar',
          data: {
            labels: platforms,
            datasets: [{
              label: 'จำนวนงาน',
              data: platformData,
              backgroundColor: '#3b82f6',
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(100, 150, 255, 0.1)' } },
              x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
            }
          }
        });
      } else {
        charts.platform.data.labels = platforms;
        charts.platform.data.datasets[0].data = platformData;
        charts.platform.update();
      }

      // Type Chart
      const typeLabels = ['Artwork', 'Video', 'Motion', 'Script'];
      const typeKeywords = ['ออกแบบใหม่|re design', 'ตัดคลิป|video', 'motion', 'จองคิว|script'];
      const typeData = typeKeywords.map(regex =>
        filteredData.filter(r => new RegExp(regex, 'i').test((r.Type || ''))).length
      );

      if (!charts.type) {
        charts.type = new Chart(document.getElementById('typeChart'), {
          type: 'bar',
          data: {
            labels: typeLabels,
            datasets: [{
              label: 'จำนวนงาน',
              data: typeData,
              backgroundColor: '#8b5cf6',
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(100, 150, 255, 0.1)' } },
              x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
            }
          }
        });
      } else {
        charts.type.data.datasets[0].data = typeData;
        charts.type.update();
      }
    }

    /* ==============================
       TABLE
    =============================== */
    function updateTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      // ✨ FIX: อย่าเก็บเลขแถวล่วงหน้า ให้ใช้ _orig สำหรับคืนลำดับเดิม และ i+1 ขณะเรนเดอร์
      const sorted = [...filteredData]
        .map((row, idx) => ({ ...row, __qty: getQty(row), _orig: idx }))
        .sort((a, b) => {
          if (sortKey === 'row') return sortDir * (a._orig - b._orig);

          if (sortKey === '__qty'){
            if (a.__qty === b.__qty) return 0;
            return sortDir * (a.__qty > b.__qty ? 1 : -1);
          }

          let valA = a[sortKey];
          let valB = b[sortKey];

          if (sortKey === 'Status') {
            valA = computeStatus(a);
            valB = computeStatus(b);
          }

          if (['Deadline', 'Date', 'MaxDate'].includes(sortKey)) {
            valA = parseThaiDate(valA);
            valB = parseThaiDate(valB);
          } else {
            valA = (valA || '').toString().toLowerCase();
            valB = (valB || '').toString().toLowerCase();
          }

          if (valA === valB) return 0;
          if (!valA) return 1;
          if (!valB) return -1;
          return sortDir * (valA > valB ? 1 : -1);
        });

      sorted.forEach((row, i) => {
        const status = computeStatus(row);
        
        // แยก Platform ที่มีหลายค่า
        const platforms = (row.Platform || '-').split(',').map(p => p.trim()).filter(p => p !== '-');
        const platformHTML = platforms.length > 0 
          ? platforms.map(p => `<span class="platform-tag">${p}</span>`).join(' ')
          : '<span style="color: var(--text-muted)">-</span>';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td style="font-weight: 600;">${row.__qty || '-'}</td>
          <td>${platformHTML}</td>
          <td title="${row.Product || ''}">${row.Product || '-'}</td>
          <td title="${row.Type || ''}">${row.Type || '-'}</td>
          <td title="${row.Project || ''}">${row.Project || '-'}</td>
          <td title="${row.Remark || ''}">${row.Remark || '-'}</td>
          <td>${row.Designer || '-'}</td>
          <td>${fmtDateDisplay(row.Date)}</td>
          <td>${fmtDateDisplay(row.Deadline)}</td>
          <td>
            <span class="badge ${
              {
                'เสร็จแล้ว': 'badge-done',
                'อยู่ในกำหนด': 'badge-ongoing',
                'เลยกำหนด': 'badge-overdue',
                'ยังไม่ได้กำหนด': 'badge-pending'
              }[status] || 'badge-pending'
            }">${status}</span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ==============================
       EVENTS
    =============================== */
    // Tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const page = tab.dataset.page;
        document.getElementById('dashboardView').classList.toggle('hidden', page !== 'dashboard');
        document.getElementById('detailsView').classList.toggle('hidden', page !== 'details');
      });
    });

    // Filters
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('platformFilter').addEventListener('change', applyFilters);
    document.getElementById('designerFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('dateSourceFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);

    // Quick ranges
    document.getElementById('btn7Days').addEventListener('click', () => {
      const today = new Date();
      const from = new Date(today);
      from.setDate(from.getDate() - 6);
      document.getElementById('dateFrom').value = from.toISOString().split('T')[0];
      document.getElementById('dateTo').value = today.toISOString().split('T')[0];
      applyFilters();
    });

    document.getElementById('btn30Days').addEventListener('click', () => {
      const today = new Date();
      const from = new Date(today);
      from.setDate(from.getDate() - 29);
      document.getElementById('dateFrom').value = from.toISOString().split('T')[0];
      document.getElementById('dateTo').value = today.toISOString().split('T')[0];
      applyFilters();
    });

    document.getElementById('btnThisMonth').addEventListener('click', () => {
      const now = new Date();
      const first = new Date(now.getFullYear(), now.getMonth(), 1);
      const last  = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      document.getElementById('dateFrom').value = first.toISOString().split('T')[0];
      document.getElementById('dateTo').value   = last.toISOString().split('T')[0];
      applyFilters();
    });

    // CSV Import
    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('csvFileInput').click();
    });

    document.getElementById('csvFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        const rows = text.split(/\r?\n/).map(row => row.split(','));
        const headers = rows[0] || [];

        data = rows.slice(1).filter(row => row.filter(Boolean).length).map(row => {
          const obj = {};
          headers.forEach((header, idx) => {
            obj[(header || '').trim()] = row[idx] ? row[idx].trim() : '';
          });
          return obj;
        });

        data = data.map(r => ({ ...r, Approved: toBool(r.Approved) })).filter(isMeaningfulRow);

        buildFilters();
        applyFilters();

        const statusEl = document.getElementById('connectionStatus');
        statusEl.textContent = '📁 ใช้ไฟล์ CSV';
        statusEl.style.background = 'rgba(59, 130, 246, 0.1)';
        statusEl.style.borderColor = 'rgba(59, 130, 246, 0.3)';
        statusEl.style.color = 'var(--accent-blue)';
      };

      reader.readAsText(file);
      e.target.value = '';
    });

    // PDF Export
    document.getElementById('exportBtn').addEventListener('click', async () => {
      try {
        const dashboard = document.getElementById('dashboardView');
        dashboard.style.background = '#0a0e1a';
        
        const canvas = await html2canvas(dashboard, {
          scale: 2,
          backgroundColor: '#0a0e1a',
          logging: false,
          allowTaint: true,
          useCORS: true,
          scrollY: -window.scrollY
        });

        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        
        if (!jsPDF) {
          throw new Error('jsPDF not loaded');
        }

        const pdf = new jsPDF('landscape', 'pt', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pageWidth - 40;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        pdf.text('TVD Content Dashboard Report', 20, 30);
        pdf.addImage(imgData, 'PNG', 20, 50, imgWidth, Math.min(imgHeight, pageHeight - 70));

        const d = new Date();
        const filename = `tvd-dashboard-${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}.pdf`;
        pdf.save(filename);

      } catch (error) {
        console.error('PDF Export error:', error);
        alert('ไม่สามารถสร้าง PDF ได้ กรุณาลองใหม่อีกครั้ง');
      }
    });

    // Sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.sort;
        if (sortKey === key) { sortDir *= -1; }
        else { sortKey = key; sortDir = 1; }
        updateTable();
      });
    });

    // Reset button
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      document.getElementById('platformFilter').value = '';
      document.getElementById('designerFilter').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('dateSourceFilter').value = 'Deadline';
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      loadData();
    });

    // Init
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
